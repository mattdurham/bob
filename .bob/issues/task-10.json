{
  "id": "task-10",
  "title": "Enhance review prompts with validation checks that caught Copilot's issues",
  "description": "## Problem\nOur enhanced review prompts (task-6) caught some issues during self-test, but Copilot still found 9 real issues we missed:\n\n1. **Nested code fences** - Markdown parsing errors\n2. **Broken grep commands** - `\\b` doesn't work in standard grep\n3. **Escaped backticks** - Searching for wrong pattern\n4. **Escaped quotes** - Backslashes included in examples\n5. **Missing PR documentation** - Files mentioned but not included\n\n## Root Cause Analysis\n\nOur prompts missed these because:\n- **No command validation** - Didn't test if bash commands actually work\n- **No markdown validation** - Didn't check for nested fence issues\n- **No PR description check** - Didn't cross-reference description vs files\n- **Limited scope** - Focused on structure not content validation\n\n## Goals\nAdd specific validation checks to catch these types of issues:\n\n### 1. Command Validation Check\nAdd to PASS 2 validation commands:\n```markdown\n**Command Validation:**\nWhen reviewing prompts/documentation with bash commands:\n- Check for POSIX compliance (avoid `\\b`, use `\\\u003c` and `\\\u003e`)\n- Verify grep patterns are not over-escaped\n- Test commands would actually work if executed\n- Flag commands that search for escaped literals (e.g., `\\`\\`\\``)\n```\n\n### 2. Markdown Structure Validation\nAdd to PASS 3 documentation checks:\n```markdown\n**Markdown Structure:**\n- Check for nested code fences (inner ``` inside outer ```)\n- Suggest using ~~~ or 4-backtick fence for outer blocks\n- Verify code fence language tags are correct\n- Check for properly closed fences\n```\n\n### 3. Escape Character Check\nAdd pattern to watch for:\n```markdown\n**Pattern 6: Over-Escaped Text**\n❌ Examples with unnecessary backslashes: `\\\"retry_count\\\"`, `\\`\\`\\``\n✅ Use proper quoting instead: `\"retry_count\"`, `` ``` ``\n**How to detect:** Look for `\\\"` and `\\`` in example code\n```\n\n### 4. PR Description Validation\nAdd to PASS 1 cross-file checks:\n```markdown\n**PR Description Validation:**\nWhen reviewing PRs (if applicable):\n- Extract files mentioned in PR description/commit message\n- Verify all mentioned files exist in the changeset\n- Flag mismatches: \"PR mentions bots/file.md but it's not included\"\n```\n\n### 5. Prompt-Specific Validation\nSince prompts are meta (instructions for other agents):\n```markdown\n**Prompt Self-Validation:**\nWhen reviewing prompt files (*.md in prompts/):\n- Validate that commands in prompts would work\n- Check that examples are syntactically correct\n- Verify nested structures render properly\n- Test that agents could actually execute the instructions\n```\n\n## Implementation\n\n### Files to Modify\n- `cmd/bob/prompts/code-review/02-review.md` - Add new validation checks\n- `cmd/bob/prompts/brainstorm/07-review.md` - Add new validation checks\n\n### Add These Sections\n\n#### In PASS 2 (Code Quality):\n```markdown\n**For Prompt/Documentation Files:**\n- Validate bash commands are POSIX-compliant\n- Check grep patterns use correct syntax (\\\u003c \\\u003e not \\b)\n- Verify no over-escaped characters in examples\n- Test find commands search for correct patterns\n```\n\n#### In PASS 3 (Documentation):\n```markdown\n**Markdown Structure Validation:**\nCommands to run:\n```bash\n# Check for nested code fences\ngrep -n '```' file.md | awk 'NR%2==1 {open=$0} NR%2==0 {print open; print $0}'\n\n# Find files with many backtick escapes (potential over-escaping)\ngrep -n '\\\\`' file.md\ngrep -n '\\\\\"' file.md\n```\n\n#### Add Pattern 6 to Error Patterns:\n```markdown\n### Pattern 6: Over-Escaped Text\n❌ `\\\"retry_count\\\"` - Backslashes will be included literally\n✅ `\"retry_count\"` - Properly quoted without escaping\n\n❌ `\\`\\`\\`` - Searches for literal backslash-backtick\n✅ ``` - Searches for actual backticks\n```\n\n## Success Criteria\n- Enhanced prompts catch the 4 types of issues Copilot found\n- Command validation detects POSIX compliance issues\n- Markdown validation catches nested fence problems\n- Escape character detection flags over-escaped text\n- Self-test on fixed prompts finds no new issues\n\n## Testing Plan\n1. Run enhanced prompts on the fixed code (should find no issues)\n2. Run enhanced prompts on the ORIGINAL code (should find the 9 Copilot issues)\n3. Compare findings - should match Copilot's feedback\n4. Validate no false positives on other files\n\n## Expected Outcome\nNext iteration of prompts should catch:\n- ✅ Nested markdown fences\n- ✅ POSIX grep issues\n- ✅ Over-escaped characters\n- ✅ Broken command patterns\n- ✅ PR description mismatches\n\nThis makes the prompts self-improving - they learn from feedback.\n\n## Related\n- Builds on task-6 (initial prompt enhancement)\n- Addresses gaps found in real-world Copilot review\n- Makes prompts more robust and comprehensive",
  "type": "feature",
  "priority": "medium",
  "state": "pending",
  "tags": [
    "enhancement",
    "review-process",
    "prompts",
    "self-improvement"
  ],
  "createdAt": "2026-02-09T17:28:54.513935935-05:00",
  "updatedAt": "2026-02-09T17:28:54.51393599-05:00"
}